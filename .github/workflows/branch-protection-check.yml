name: Branch Protection Check

on:
  schedule:
    # Run weekly to verify branch protection is properly configured
    - cron: '0 9 * * 1'  # Every Monday at 9 AM UTC
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: read

jobs:
  check-branch-protection:
    name: Verify Branch Protection Settings
    runs-on: ubuntu-latest
    
    steps:
    - name: Check Branch Protection
      run: |
        echo "üîç Checking branch protection settings for auto-merge compatibility..."
        echo ""
        echo "Required settings for auto-merge to work properly:"
        echo "1. ‚úÖ Require status checks to pass before merging"
        echo "2. ‚úÖ Required status check: 'CI Success'"
        echo "3. ‚úÖ Require branches to be up to date before merging"
        echo "4. ‚úÖ Allow auto-merge (in repository settings)"
        echo "5. ‚úÖ GitHub Actions has write permissions"
        echo ""
        echo "To configure these settings:"
        echo "- Go to Settings ‚Üí Branches ‚Üí Add rule for 'main'"
        echo "- Go to Settings ‚Üí General ‚Üí Enable 'Allow auto-merge'"
        echo "- Go to Settings ‚Üí Actions ‚Üí General ‚Üí Enable write permissions"
        echo ""
        echo "üìñ For detailed instructions, see: .github/AUTO_MERGE_SETUP.md"

  verify-dependabot-config:
    name: Verify Dependabot Configuration
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check Dependabot Config
      run: |
        echo "ü§ñ Verifying Dependabot configuration..."
        
        if [ -f ".github/dependabot.yml" ]; then
          echo "‚úÖ Dependabot configuration found"
          echo ""
          echo "Configuration summary:"
          grep -A 10 "package-ecosystem:" .github/dependabot.yml || true
        else
          echo "‚ùå Dependabot configuration missing"
          exit 1
        fi

  verify-workflows:
    name: Verify Auto-Merge Workflows
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check Required Workflows
      run: |
        echo "üîÑ Verifying auto-merge workflows..."
        
        required_workflows=(
          ".github/workflows/dependabot-auto-merge.yml"
          ".github/workflows/ci.yml"
        )
        
        all_present=true
        
        for workflow in "${required_workflows[@]}"; do
          if [ -f "$workflow" ]; then
            echo "‚úÖ $workflow found"
          else
            echo "‚ùå $workflow missing"
            all_present=false
          fi
        done
        
        if [ "$all_present" = false ]; then
          echo ""
          echo "Some required workflows are missing. Auto-merge may not work properly."
          exit 1
        fi
        
        echo ""
        echo "‚úÖ All required workflows are present"
